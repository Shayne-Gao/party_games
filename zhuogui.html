<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>æ‰é¬¼å¤§å¸ˆ PRO - é€»è¾‘ä¿®å¤ç‰ˆ</title>
    <style>
        /* æ ·å¼ä¿æŒä¸€è‡´ï¼Œä¸ºèŠ‚çœç¯‡å¹…ç•¥ä½œå‹ç¼© */
        :root { --primary: #f39c12; --secondary: #3498db; --ghost: #2c3e50; --bg: #f5f6fa; --card-bg: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .app-container { width: 100%; max-width: 480px; padding: 20px; box-sizing: border-box; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .glass-card { background: var(--card-bg); border-radius: 20px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .section-title { font-weight: bold; font-size: 0.9rem; color: #7f8c8d; margin-bottom: 15px; display: block; }
        .role-tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .role-mini-tag { padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; background: #f1f2f6; }
        .tag-a { background: #e1f5fe; color: #039be5; }
        .tag-b { background: #fff3e0; color: #fb8c00; }
        .tag-w { background: #f3e5f5; color: #9b59b6; }
        .tag-g { background: #feeef2; color: #e91e63; }
        .card-container { height: 320px; perspective: 1000px; margin: 20px 0; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; cursor: pointer; }
        .card-inner.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 25px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .card-front { background: var(--primary); color: white; }
        .card-back { background: white; border: 4px solid var(--primary); transform: rotateY(180deg); }
        .status-header { background: #2d3436; color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; cursor: pointer; position: relative; }
        .eye { position: absolute; right: 15px; }
        .names-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .name-input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        .btn { background: var(--ghost); color: white; border: none; padding: 16px; border-radius: 15px; font-size: 1.1rem; font-weight: bold; width: 100%; cursor: pointer; }
        .vote-item { background: white; padding: 18px; border-radius: 15px; text-align: center; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.04); }
        .vote-item.out { background: #dfe6e9; color: #b2bec3; text-decoration: line-through; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="page-1" class="page active">
        <h1>ğŸ‘» æ‰é¬¼å‘ç‰ŒåŠ©æ‰‹</h1>
        <div class="glass-card">
            <span class="section-title">æ¸¸æˆé…ç½®</span>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span>æ€»äººæ•°</span>
                <div style="display:flex; align-items:center; gap:15px;">
                    <button onclick="changeTotal(-1)" style="width:30px; height:30px; border-radius:50%; border:none;">-</button>
                    <b id="ui-total">6</b>
                    <button onclick="changeTotal(1)" style="width:30px; height:30px; border-radius:50%; border:none;">+</button>
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span>åŠ å…¥ç™½æ¿(å¥½äººé˜µè¥)</span>
                <input type="checkbox" id="check-blank" onchange="renderSetup()">
            </div>
            <div class="role-tag-container" id="ui-role-tags"></div>
        </div>
        <div class="glass-card">
            <span class="section-title">é€‰æ‹©è¯åº“åˆ†ç±»</span>
            <select id="select-topic" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;"></select>
        </div>
        <div class="glass-card">
            <span class="section-title">ç©å®¶åå•</span>
            <div class="names-grid" id="names-container"></div>
        </div>
        <button class="btn" onclick="onStart()">ç¡®å®šåˆ†é…ï¼Œå¼€å§‹å‘ç‰Œ</button>
    </div>

    <div id="page-2" class="page">
        <h2 style="text-align:center;">èº«ä»½å‘æ”¾</h2>
        <p id="turn-hint" style="text-align:center; color:#666;"></p>
        <div class="card-container" onclick="handleFlip()">
            <div class="card-inner" id="card-inner">
                <div class="card-front">
                    <div id="front-icon" style="font-size:3rem; margin-bottom:10px;">ğŸ¤«</div>
                    <div id="p-name" style="font-size:1.5rem; font-weight:bold;"></div>
                    <p id="front-tip">ç‚¹å‡»ç¿»ç‰Œ</p>
                </div>
                <div class="card-back">
                    <div id="role-label" style="font-size:0.9rem; color:var(--primary); font-weight:bold;"></div>
                    <div id="word-val" style="font-size:1.8rem; font-weight:bold; margin:20px 0; line-height:1.2;"></div>
                    <p style="font-size:0.8rem; color:#95a5a6;">ç‚¹å‡»éšè—å¹¶ä¼ é€’æ‰‹æœº</p>
                </div>
            </div>
        </div>
    </div>

    <div id="page-3" class="page">
        <h2 style="text-align:center;">æŠ•ç¥¨è®¨è®º</h2>
        <div class="status-header" onclick="toggleStatus()">
            <span id="st-title">ğŸ“Š å­˜æ´»ç»Ÿè®¡ (å·²éšè—)</span>
            <span class="eye" id="st-eye">ğŸ‘ï¸â€ğŸ—¨ï¸</span>
            <div id="st-content" style="display:none; margin-top:10px; border-top:1px solid #555; padding-top:10px;"></div>
        </div>
        <div class="names-grid" id="vote-list"></div>
        <button class="btn" style="margin-top:20px; background:#95a5a6;" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
    </div>
</div>

<script>
const rawLibrary = {
    "èˆŒå°–è¯±æƒ‘": `ç«é”…|å†’èœ|ä¸€ç§é£Ÿç‰©|2\né¦’å¤´|åŒ…å­|ä¸€ç§ä¸»é£Ÿ|2\næ‹¿é“|å¡å¸ƒ|ä¸€ç§é¥®å“|2\næ±‰å ¡|è–¯æ¡|ä¸€ç§å¿«é¤|2\nè¥¿ç“œ|ç”œç“œ|ä¸€ç§æ°´æœ|2\nè”æ|é¾™çœ¼|ä¸€ç§æ°´æœ|2\nèºè›³ç²‰|é…¸è¾£ç²‰|ä¸€ç§é¢é£Ÿ|3\né¸­è„–|é¸¡çˆª|ä¸€ç§ç†Ÿé£Ÿ|2\nçƒ¤è‚‰|ç‚¸é¸¡|ä¸€ç§è¤èœ|2\næŠ«è¨|æ„é¢|æ„å¼æ–™ç†|2\nå¥¶èŒ¶|æœæ±|ä¸€ç§é¥®å“|2\né¾™è™¾|èƒèŸ¹|ä¸€ç§æµ·é²œ|2\néŸ­èœ|èŠ¹èœ|ä¸€ç§è”¬èœ|2\né¦™è•‰|èŠ­è•‰|ä¸€ç§æ°´æœ|2\né¥¼å¹²|è–¯ç‰‡|ä¸€ç§é›¶é£Ÿ|2\nçº¢çƒ§è‚‰|é”…åŒ…è‚‰|ä¸€ç§è‚‰èœ|3\nå†°æ·‡æ·‹|åœ£ä»£|ä¸€ç§ç”œå“|3/2\néº»è¾£çƒ«|éº»è¾£æ‹Œ|ä¸€ç§å°åƒ|3\næ‹…æ‹…é¢|çƒ­å¹²é¢|ä¸€ç§é¢é£Ÿ|3\nç±³çº¿|ç²‰ä¸|ä¸€ç§é¢é£Ÿ|2\nè±†æµ†|ç‰›å¥¶|ä¸€ç§æ—©é¤é¥®å“|2\nå¯¿å¸|é¥­å›¢|ä¸€ç§å’Œå¼é£Ÿç‰©|2\nå’–å•¡|å¯ä¹|ä¸€ç§æ·±è‰²é¥®å“|2\nå·§å…‹åŠ›|æ£’æ£’ç³–|ä¸€ç§ç”œé£Ÿ|3\né¢æ¡|é¦„é¥¨|ä¸€ç§ä¼ ç»Ÿé¢é£Ÿ|2`,
    "æ•°ç ç§‘æŠ€": `å¾®ä¿¡|æ‰£æ‰£|ç¤¾äº¤è½¯ä»¶|2\næŠ–éŸ³|å¿«æ‰‹|çŸ­è§†é¢‘è½¯ä»¶|2\næ·˜å®|äº¬ä¸œ|è´­ç‰©å¹³å°|2\nç™¾åº¦|è°·æ­Œ|æœç´¢å¼•æ“|2\nå®‰å“|è‹¹æœ|æ‰‹æœºç³»ç»Ÿ|2\né”®ç›˜|é¼ æ ‡|ç”µè„‘ç¡¬ä»¶|2\nåä¸º|å°ç±³|æ‰‹æœºå“ç‰Œ|2\nè“ç‰™|æ˜¾å¡|ç”µè„‘ç¡¬ä»¶|2\næ‰‹åŠ|ç›²ç›’|ä¸€ç§æ½®ç©|2\nè€³æœº|éŸ³ç®±|æ’­æ”¾è®¾å¤‡|2\nå¹³æ¿|ç”µè„‘|ç”µå­äº§å“|2\næŠ•å½±|ç”µè§†|æ˜¾ç¤ºè®¾å¤‡|2\nç›¸æœº|æ‰‹æœº|æ‹æ‘„è®¾å¤‡|2\nå……ç”µå®|é€‚é…å™¨|ç”µæºé…ä»¶|3/3\nå“”å“©å“”å“©|å°çº¢ä¹¦|ç¤¾åŒºå¹³å°|4/3\nç‹è€…è£è€€|å’Œå¹³ç²¾è‹±|ç«æŠ€æ‰‹æ¸¸|4\nå¿«é€’|å¤–å–|ä¸€ç§é…é€æœåŠ¡|2\nå•å|å¾®å•|æ‘„å½±å™¨æ|2\nå›ºæ€|æœºæ¢°|å­˜å‚¨è®¾å¤‡|2\nç§»åŠ¨|è”é€š|ç”µä¿¡è¿è¥å•†|2`,
    "æ—¥å¸¸çç¢": `ç‰™åˆ·|ç‰™ç­¾|æ—¥å¸¸ç”¨å“|2\né›¨ä¼|é›¨è¡£|é›¨å…·|2\né•œå­|çª—æˆ·|å±…å®¶ç‰©å“|2\né—¹é’Ÿ|æ‰‹è¡¨|è®¡æ—¶å·¥å…·|2\né’¥åŒ™|é—¨å¡|ç”Ÿæ´»å·¥å…·|2\nèƒ¶æ°´|èƒ¶å¸¦|æ–‡å…·ç”¨å“|2\nçº¸å·¾|æ¹¿å·¾|æ¸…æ´ç”¨å“|2\nèŠ±ç“¶|ç›†æ ½|è£…é¥°ç‰©å“|2\nç”µæ‰‡|ç©ºè°ƒ|é™æ¸©è®¾å¤‡|2\nç”µæ¢¯|æ¥¼æ¢¯|å‚ç›´è®¾æ–½|2\nè¢œå­|æ‰‹å¥—|æœé¥°é…ä»¶|2\né’¢ç¬”|åœ†ç ç¬”|ä¹¦å†™æ–‡å…·|2\næŠ¹å¸ƒ|æ¯›å·¾|æ¸…æ´ç”¨å“|2\næ‹–æŠŠ|æ‰«å¸š|æ¸…æ‰«å·¥å…·|2\næ¢³å­|åˆ·å­|ç†å®¹å·¥å…·|2\nä¿¡å°|æ˜ä¿¡ç‰‡|é€šä¿¡è½½ä½“|2/3\nè¢«å­|æ¯¯å­|åºŠä¸Šç”¨å“|2`,
    "èŒåœºé£äº‘": `é’‰é’‰|é£ä¹¦|åŠå…¬è½¯ä»¶|2\nåŠ ç­|å›¢å»º|å…¬å¸æ´»åŠ¨|2\nè€æ¿|å®¢æˆ·|èŒåœºäººç‰©|2\nå‘¨æŠ¥|æ€»ç»“|èŒåœºæ–‡ä¹¦|2\né¢è¯•|ç¦»èŒ|èŒåœºæµç¨‹|2\nå¥–é‡‘|ææˆ|èŒåœºè–ªèµ„|2\nåç‰‡|å·¥ç‰Œ|èŒåœºç‰©ä»¶|2\nå…¬ç« |ç­¾å­—|åŠå…¬è¡Œä¸º|2\nè¾èŒ|è·³æ§½|èŒåœºå˜åŠ¨|2\nå…¥èŒ|è¯•ç”¨|èŒåœºé˜¶æ®µ|2`
};

function parseLib(lib) {
    const final = {};
    for (const key in lib) {
        final[key] = lib[key].trim().split('\n').map(line => {
            const parts = line.split('|').map(s => s.trim());
            return { a: parts[0], b: parts[1], h: `${parts[2]} (${parts[3]}ä¸ªå­—)` };
        });
    }
    return final;
}

const library = parseLib(rawLibrary);
let state = { total: 6, a:0, b:0, g:0, hasW: false, players: [], current: 0, flipped: false, stVisible: false };

// --- æ ¸å¿ƒä¿®å¤ï¼šFisher-Yates æ´—ç‰Œç®—æ³• ---
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function changeTotal(n) { state.total = Math.max(4, Math.min(12, state.total + n)); renderSetup(); }

function renderSetup() {
    state.hasW = document.getElementById('check-blank').checked;
    state.g = Math.max(1, Math.floor(state.total / 3));
    let rem = state.total - state.g;
    let a = Math.floor(rem / 2), b = rem - a, w = 0;
    if(state.hasW) { if(a >= b) a--; else b--; w=1; }
    document.getElementById('ui-total').innerText = state.total;
    document.getElementById('ui-role-tags').innerHTML = `<span class="role-mini-tag tag-a">Aç»„:${a}</span><span class="role-mini-tag tag-b">Bç»„:${b}</span>${w?`<span class="role-mini-tag tag-w">ç™½æ¿:1</span>`:''}<span class="role-mini-tag tag-g">é¬¼:${state.g}</span>`;
    const container = document.getElementById('names-container');
    const old = Array.from(container.querySelectorAll('input')).map(i => i.value);
    container.innerHTML = '';
    for(let i=1; i<=state.total; i++) container.innerHTML += `<input type="text" class="name-input" id="n-${i}" value="${old[i-1]||'ç©å®¶'+i}">`;
    state.a = a; state.b = b;
}

function initTopics() {
    const sel = document.getElementById('select-topic');
    for(const key in library) {
        const opt = document.createElement('option');
        opt.value = key; opt.innerText = key; sel.appendChild(opt);
    }
}

function onStart() {
    const topic = document.getElementById('select-topic').value;
    const items = library[topic];
    const set = items[Math.floor(Math.random()*items.length)];
    
    let rolePool = [];
    for(let i=0; i<state.a; i++) rolePool.push({role:'A', w:set.a, l:'å¥½äºº A ç»„'});
    for(let i=0; i<state.b; i++) rolePool.push({role:'B', w:set.b, l:'å¥½äºº B ç»„'});
    if(state.hasW) rolePool.push({role:'W', w:'???', l:'ç™½æ¿ (å¥½äººé˜µè¥)'});
    for(let i=0; i<state.g; i++) rolePool.push({role:'G', w:set.h, l:'ä½ æ˜¯é¬¼ (çœ‹æç¤º)'});

    // ä½¿ç”¨ä¿®å¤åçš„å½»åº•æ´—ç‰Œç®—æ³•
    shuffle(rolePool);

    // é‡æ–°å…³è”æ˜µç§°
    state.players = rolePool.map((x, i) => ({
        name: document.getElementById(`n-${i+1}`).value,
        ...x,
        out: false
    }));

    state.current = 0; state.flipped = false;
    showPage(2); updateCard();
}

function updateCard() {
    const p = state.players[state.current];
    document.getElementById('card-inner').classList.remove('flipped');
    document.getElementById('front-icon').innerText = "ğŸ¤«";
    document.getElementById('p-name').innerText = p.name;
    document.getElementById('front-tip').innerText = "ç‚¹å‡»ç¿»ç‰Œ";
    document.getElementById('turn-hint').innerText = `è¯· ${p.name} æ¥è¿‡æ‰‹æœº`;
}

function handleFlip() {
    const inner = document.getElementById('card-inner');
    const p = state.players[state.current];
    if(!state.flipped) {
        document.getElementById('role-label').innerText = p.l;
        document.getElementById('word-val').innerText = p.w;
        inner.classList.add('flipped');
        state.flipped = true;
    } else {
        inner.classList.remove('flipped');
        state.flipped = false;
        document.getElementById('front-icon').innerText = "âœ…";
        document.getElementById('front-tip').innerText = "å·²éšè—ï¼Œä¼ ç»™ä¸‹ä¸€ä½";
        setTimeout(() => {
            state.current++;
            if(state.current < state.players.length) updateCard();
            else { showPage(3); renderVote(); }
        }, 600);
    }
}

function renderVote() {
    const list = document.getElementById('vote-list');
    list.innerHTML = '';
    state.players.forEach((p,i)=>{
        const div = document.createElement('div');
        div.className = `vote-item ${p.out?'out':''}`;
        div.innerText = p.name;
        div.onclick = () => { if(!p.out && confirm(`æŠ•å‡º ${p.name}?`)) { state.players[i].out=true; renderVote(); }};
        list.appendChild(div);
    });
    updateStatus();
}

function toggleStatus() {
    state.stVisible = !state.stVisible;
    document.getElementById('st-content').style.display = state.stVisible ? 'block' : 'none';
    document.getElementById('st-title').innerText = state.stVisible ? 'ğŸ“Š å®æ—¶æˆ˜å†µ' : 'ğŸ“Š å­˜æ´»ç»Ÿè®¡ (å·²éšè—)';
    document.getElementById('st-eye').innerText = state.stVisible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸';
}

function updateStatus() {
    const alive = state.players.filter(p=>!p.out);
    const g = alive.filter(p=>p.role==='G').length;
    const goods = alive.filter(p=>p.role!=='G').length;
    const a = alive.filter(p=>p.role==='A').length;
    const b = alive.filter(p=>p.role==='B').length;
    document.getElementById('st-content').innerHTML = `å¥½äººæ€»å­˜æ´»ï¼š${goods} <br> é¬¼é˜µè¥å­˜æ´»ï¼š${g}`;
    if(g===0) alert("ğŸ‰ å¥½äººè·èƒœï¼æ‰€æœ‰çš„é¬¼å·²è¢«æŠ•å‡º");
    else if(g >= goods) alert("ğŸ’€ é¬¼è·èƒœï¼äººæ•°å¯¹é¬¼æœ‰åˆ©");
    else if(a===0 || b===0) alert("ğŸ’€ é¬¼è·èƒœï¼ä¸€ç»„å¥½äººå·²å…¨ç­");
}

function showPage(n) {
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById('page-'+n).classList.add('active');
}

initTopics();
renderSetup();
</script>
</body>
</html>
